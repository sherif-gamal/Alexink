<%= render "layouts/ajaxify" %>

<style>
th, td { white-space: nowrap; }
    div.dataTables_wrapper {
        width: 500%;
    }
</style>
<div class="row">
  <div id="breadcrumb" class="col-md-12">
    <ol class="breadcrumb">
      <li><a href="#">الصفحة الرئيسية</a></li>
      <li><a href="#">اليوميات</a></li>
      <li><a href="#">يوميات الحركات</a></li>
    </ol>
  </div>
</div>

<div>
  <div class="col-sm-2">
    حتى
    <input type="text" id="input_date-2" class="form-control" placeholder="تاريخ النهاية" value="<%=@_end.strftime("%m/%d/%Y")%>">
  </div>
  <div class="col-sm-2">
    بداية من
    <input type="text" id="input_date" class="form-control" placeholder="تاريخ البداية" value="<%=@_start.strftime("%m/%d/%Y")%>">  
  </div>
</div>

<div class="row" id="table1">
  <div class="col-xs-12">
    <div class="box">
      <div class="box-header">
        <div align="center" class="box-name">
          <span id="title"></span>
        </div>

        <div class="no-move"></div>
      </div>
      <div class="box-content no-padding table-responsive" style="white-space:pre;overflow:auto;width:100%;padding:10px;">
        <table class="table table-bordered table-hover" id="table">
          <thead>
            <tr>
              <th rowspan="2" width="40px">رقم القيد</th>
              <th rowspan="2" width="70px">التاريخ</th>
              <th rowspan="2" >الدائن/المدين</th>
              <th rowspan="2" >البيان</th>
              <th colspan="2" class="text-center">الإجمالي</th>
              <th colspan="2" class="text-center">الخزينة</th>
              <th colspan="2" class="text-center">بنك الإمارات دبي</th>
              <th colspan="2" class="text-center">بنك الإمارات دبي دولار</th>
              <th colspan="2" class="text-center">بنك الإمارات دبي يورو</th>
              <th colspan="2" class="text-center">بنك الإسكان والتعمير</th>
              <th colspan="2" class="text-center">بنك الإسكان والتعميل دولار</th>
              <th colspan="2" class="text-center">بنك الإسكان والتعميل يورو</th>
              <th colspan="2" class="text-center">فروق عملة</th>

              <th colspan="2" class="text-center">م. تشغيل</th>
              <th colspan="2" class="text-center">م. بيعية</th>
              <th colspan="2" class="text-center">م. عمومية إدارية</th>
              <th colspan="2" class="text-center">أ . ق</th>
              <th colspan="2" class="text-center">أ . ق برسم التحصيل</th>
              <th colspan="2" class="text-center">اعتمادات مستندية</th>
              <th colspan="2" class="text-center">إيجار مقدم</th>
              <th colspan="2" class="text-center">موردين</th>

              <th colspan="2" class="text-center">مشتريات</th>
              <th colspan="2" class="text-center">م. على المشتريات</th>
              <th colspan="2" class="text-center">موردين خارجيين</th>
              <th colspan="2" class="text-center">عملاء</th>
              <th colspan="2" class="text-center">مبيعات</th>
              <th colspan="2" class="text-center">ض مبيعات</th>
              
              <th colspan="2" class="text-center">ض أ ص</th>
              
              
              
              <th colspan="2" class="text-center">أصول ث</th>
              
              
              
              
              <th colspan="2" class="text-center">ضرائب على الدخل</th>
              
              <th colspan="2" class="text-center">دائنون مساهمون</th>
              
              
              <th colspan="2" class="text-center">أخرى</th>
            </tr>
                        <tr>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
              <th style="width: 50px" class="text-center">دائن</th>
              <th style="width: 60px" class="text-center">مدين</th>
            </tr>
          </thead>
          <tbody>
            <%number = 1%>
            <% @all.each do |a| %>
              <%if a.is_a? Expense%>
                <%url = "/expense_payment_detail/#{a.id}"%>
                <%detail = ExpensePaymentDetail.find_by_id(a.id)%>
              <%elsif a.is_a? Material%>
                <%url = "/material_payment_detail/#{a.id}"%>
                <%detail = MaterialPaymentDetail.find_by_id(a.id)%>
              <%elsif a.is_a? Purchase%>
                <%url = "/purchase_payment_detail/#{a.id}"%>
                <%detail = PurchasePaymentDetail.find_by_id(a.id)%>
              <%end%>
              <%if !detail%>
                <%next%>
              <%end%>
              <tr data-href=<%=url%>>
                <td><%=number%></td>
                <td><%=a.date_added.blank? ? (d a.created_at) : a.date_added%></td>
                <%if a.is_a? Expense%>
                  <td><%=a.seller%></td>
                  <td><%=a.name%></td>
                  <td><%=a.price%></td>
                  <td><%=a.price%></td>
                <%elsif a.is_a? Material%>
                  <td><%= Supplier.find(a.supplier_id).name%></td>
                  <td>
                  <% @raw_materials.find(a.raw_material_ids).each do |r| %>
                  <%= r.name%><br/>
                  <%end%>
                </td>
                  <td><%=a.price_with_taxes%></td>
                  <td><%=a.price_with_taxes%></td>
                <%elsif a.is_a? Purchase%>
                  <td><%= Client.find(a.client_id).name%>
                  <td><%="ف رقم #{a.invoice_id}"%></td>
                  <td><%=a.price_with_taxes%></td>
                  <td><%=a.price_with_taxes%></td>
                <%end%>
                <td><%=detail.treasury_debt%></td>
                <td><%=detail.treasury_credit%></td>
                <td><%=detail.bnp_debt%></td>
                <td><%=detail.bnp_credit%></td>
                <td><%=detail.bnp_dollar_debt%></td>
                <td><%=detail.bnp_dollar_credit%></td>
                <td><%=detail.bnp_euro_debt%></td>
                <td><%=detail.bnp_euro_credit%></td>
                
                <td><%=detail.abu_dhabi_debt%></td>
                <td><%=detail.abu_dhabi_credit%></td>
                <td><%=detail.abu_dhabi_dollar_debt%></td>
                <td><%=detail.abu_dhabi_dollar_credit%></td>
                <td><%=detail.abu_dhabi_euro_debt%></td>
                <td><%=detail.abu_dhabi_euro_credit%></td>
                <td><%=detail.fx_difference_debt%></td>
                <td><%=detail.fx_difference_credit%></td>
                
                
                <td><%=detail.operation_expense_debt%></td>
                <td><%=detail.operation_expense_credit%></td>
                <td><%=detail.sale_expense_debt%></td>
                <td><%=detail.sale_expense_credit%></td>
                <td><%=detail.general_managerial_debt%></td>
                <td><%=detail.general_managerial_credit%></td>
                <td><%=detail.aq_debt%></td>
                <td><%=detail.aq_credit%></td>
                <td><%=detail.aq_rasm_ta7seel_debt%></td>
                <td><%=detail.aq_rasm_ta7seel_credit%></td>
                <td><%=detail.e3temadat_mostanadeya_debt%></td>
                <td><%=detail.e3temadat_mostanadeya_credit%></td>
                <td><%=detail.rental_debt%></td>
                <td><%=detail.rental_credit%></td>
                
                <td><%=detail.supplier_debt%></td>
                <td><%=detail.supplier_credit%></td>
                
                <td><%=detail.purchases_debt%></td>
                <td><%=detail.purchases_credit%></td>

                <td><%=detail.m_moshtarayat_debt%></td>
                <td><%=detail.m_moshtarayat_credit%></td>
                <td><%=detail.outer_suppliers_debt%></td>
                <td><%=detail.outer_suppliers_credit%></td>
                
                <td><%=detail.clients_debt%></td>
                <td><%=detail.clients_credit%></td>
                <td><%=detail.sales_debt%></td>
                <td><%=detail.sales_credit%></td>
                <td><%=detail.sales_tax_debt%></td>
                <td><%=detail.sales_tax_credit%></td>
                <td><%=detail.das_debt%></td>
                <td><%=detail.das_credit%></td>
                <td><%=detail.osool_sabta_debt%></td>
                <td><%=detail.osool_sabta_credit%></td>
                <td><%=detail.income_tax_debt%></td>
                <td><%=detail.income_tax_credit%></td>
                <td><%=detail.creditor_debt%></td>
                <td><%=detail.creditor_credit%></td>
                <td><%=detail.other_debt%></td>
                <td><%=detail.other_credit%></td>

              </tr>

              <%number = number + 1%>
            <% end %>
            </tr>
            <tr id="totals">
              <%60.times do%>
                <td></td>
              <%end%>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="col-xs-6 col-xs-offset-6">
  <div class="col-xs-4">
    <div class="btn btn-default btn-label-left" id="print-1"><span><i class="fa fa-floppy-o"></i></span> طباعة اليوميات</div>
  </div>
</div>


<%= javascript_include_tag 'js/jspdf.min' %>
<%= javascript_include_tag 'js/html2canvas' %>
<script type="text/javascript">
// Run Datables plugin and create 3 variants of settings
function AllTables(){
  $('#datatable-1').dataTable( {
    "aaSorting": [[ 0, "asc" ]],
    "sDom": "",
    "sPaginationType": "bootstrap",
    "scrollX": true,
    "oLanguage": {
      "sSearch": "",
      "sLengthMenu": '_MENU_'
    }

  });
  //LoadSelect2Script(MakeSelect2);
}

var f = function() {
    $.ajax({ url: '/diaries/index',
      type: 'POST',
      beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
      data: {'_start': $('#input_date').val(), '_end' : $('#input_date-2').val(), 'p_method' : $("#method option:selected").val()},
      success: function(response) {
        $('#ajax-content').html(response);
      }
    });
}
$(document).ready(function() {

  $('#input_date').datepicker({setDate: new Date()});
  $('#input_date-2').datepicker({setDate: new Date()});
  
  $('#input_date-2').change(f)
  $('#input_date').change(f)
  // Load Datatables and run plugin on tables 
  LoadDataTablesScripts(AllTables);
  // Add Drag-n-Drop feature
  WinMove();
  $("tr[data-href]").click(function() {
  window.location = this.dataset.href;
}).hover(function() {
    $(this).toggleClass('hover');
});

$("#title").text("عرض اليوميات من " + $('#input_date').val() + " إلى " + $('#input_date-2').val());


totals = []
rows = $("#table tr")
for (var i = 4; i < 60; i++)
  totals[i] = 0
for (var j = 2; j < rows.length - 1; j++) {
  for(i = 4; i < 60; i++) {
    totals[i] += (parseFloat($(rows[j].children[i]).html()) || 0)
  }
}
totals_row = $("#totals").children();

for (i = 0; i < totals_row.length; i++) {
  if (totals[i] != 0)
    $(totals_row[i]).html(totals[i]);
}
});

$('#print-1').click(function () {
  var doc = new jsPDF('p', 'pt', 'a4');
    html2canvas($("#table1"), { onrendered: function(canvas) {
      console.log(canvas.toDataURL());
      doc.addImage(canvas.toDataURL(), 'JPEG', 0, 0, 595, canvas.height);
        doc.save('diaries.pdf');
    }});
  });


</script>
